# Context Sync MCP v2.0 구현 계획

## 개요

JSON 기반 저장에서 SQLite 기반 하이브리드 저장으로 전환하여 풍부한 컨텍스트 저장과 히스토리 추적을 가능하게 한다.

### 핵심 목표

| 목표 | 설명 |
|------|------|
| 풍부한 정보 저장 | 실행 명령어, 파일 편집, 에러, 대화 요약 등 |
| 히스토리 추적 | 이전 세션들의 컨텍스트 검색/조회 |
| 의미 기반 검색 | Agent가 자연어로 과거 작업 검색 |
| 세션 연결 | 관련 작업들의 연속성 추적 |
| **토큰 효율성** | 최소 토큰으로 최대 가치 전달 |

---

## 1. 저장 방식

### 하이브리드 구조

```
.context-sync/
├── current.json     # 최근 저장 (가독성 유지, Git 추적 가능)
├── history.db       # SQLite (전체 히스토리, 쿼리 가능)
└── config.json      # 설정
```

| 저장소 | 역할 | 특징 |
|--------|------|------|
| current.json | 최근 컨텍스트 | 사람이 읽기 가능, Git 추적 |
| history.db | 전체 히스토리 | SQL 쿼리, 검색, 필터링 |

### DB 선택: sql.js (WebAssembly)

- WebAssembly 기반 (네이티브 컴파일 불필요)
- 크로스 플랫폼 (Windows/Mac/Linux 모두 npm install만으로 동작)
- FTS5 전문검색 지원
- 로컬 파일 하나로 완결
- 비동기 초기화 필요 (WASM 로드)

```bash
npm install sql.js
npm install -D @types/sql.js
```

> **Note:** better-sqlite3에서 sql.js로 변경 (2025-12-27)
> - better-sqlite3는 네이티브 C++ 모듈로 Windows에서 Visual Studio Build Tools 필요
> - sql.js는 WebAssembly 기반으로 어떤 환경에서도 npm install만으로 동작

---

## 2. 데이터베이스 스키마

### 테이블 구조 (2개)

```sql
-- 세션 컨텍스트
CREATE TABLE contexts (
  id TEXT PRIMARY KEY,
  parent_id TEXT,                    -- 이전 세션 연결 (nullable)
  goal TEXT NOT NULL,                -- 전체 목표
  goal_short TEXT,                   -- 50자 요약 (검색 결과용)
  summary TEXT,                      -- Agent가 작성한 요약 (전체)
  summary_short TEXT,                -- 100자 요약 (힌트용)
  status TEXT DEFAULT 'planning',    -- planning/coding/testing/reviewing/debugging/completed/paused
  tags TEXT DEFAULT '[]',            -- JSON 배열 ["인증", "JWT", ...]
  agent TEXT,                        -- claude-code/cursor/windsurf/copilot
  metadata TEXT DEFAULT '{}',        -- JSON (decisions, approaches, blockers 통합)
  has_warnings BOOLEAN DEFAULT 0,    -- 실패 기록/블로커 존재 여부 (빠른 필터링)
  started_at TEXT NOT NULL,
  ended_at TEXT,
  created_at TEXT DEFAULT CURRENT_TIMESTAMP,

  FOREIGN KEY (parent_id) REFERENCES contexts(id)
);

-- 전문검색 인덱스
CREATE VIRTUAL TABLE contexts_fts USING fts5(
  goal, summary, tags,
  content='contexts',
  content_rowid='rowid'
);

-- 액션 로그
CREATE TABLE actions (
  id TEXT PRIMARY KEY,
  context_id TEXT NOT NULL,
  type TEXT NOT NULL,                -- command/edit/error
  content TEXT NOT NULL,             -- 실행 내용
  result TEXT,                       -- success/failed/출력 요약
  file_path TEXT,                    -- 관련 파일 (nullable)
  created_at TEXT DEFAULT CURRENT_TIMESTAMP,

  FOREIGN KEY (context_id) REFERENCES contexts(id)
);

-- 인덱스
CREATE INDEX idx_contexts_parent ON contexts(parent_id);
CREATE INDEX idx_contexts_status ON contexts(status);
CREATE INDEX idx_contexts_agent ON contexts(agent);
CREATE INDEX idx_contexts_created ON contexts(created_at);
CREATE INDEX idx_actions_context ON actions(context_id);
CREATE INDEX idx_actions_type ON actions(type);
CREATE INDEX idx_actions_file ON actions(file_path);
```

### metadata JSON 구조

```typescript
interface ContextMetadata {
  decisions: Array<{
    what: string;
    why: string;
    madeBy: string;
    timestamp: string;
  }>;
  approaches: Array<{
    description: string;
    result: 'success' | 'failed' | 'partial';
    reason?: string;
    timestamp: string;
  }>;
  blockers: Array<{
    description: string;
    resolved: boolean;
    resolution?: string;
    discoveredAt: string;
    resolvedAt?: string;
  }>;
  codeChanges: {
    modifiedFiles: string[];
    summary: string;
  };
}
```

---

## 3. 토큰 효율성 전략

MCP 도구 응답이 Agent의 컨텍스트 윈도우를 과도하게 소비하지 않도록 설계한다.

### 핵심 원칙

| 원칙 | 설명 |
|------|------|
| **Lazy Loading** | 전체 데이터 대신 힌트/ID 먼저 반환, 상세는 요청 시 |
| **서버 사이드 요약** | Agent가 요약하지 않고 DB 저장 시 미리 생성 |
| **짧은 기본값** | goal_short(50자), summary_short(100자) 분리 저장 |
| **경고 분리** | 중요 정보만 별도 경량 엔드포인트로 제공 |

### 2단계 응답 패턴

```
┌─────────────────────────────────────────────────────┐
│  1단계: 힌트 (항상)                  ~100-200 토큰 │
│  ───────────────────────────────                    │
│  { id, goal_short, date, hasWarnings }             │
│                                                     │
│  "3개 세션 발견. 상세: context_get(id)"            │
└─────────────────────────────────────────────────────┘
                        ↓ 필요시
┌─────────────────────────────────────────────────────┐
│  2단계: 상세 (요청 시)               ~300-500 토큰 │
│  ───────────────────────────────                    │
│  { full goal, summary, metadata, actions }         │
└─────────────────────────────────────────────────────┘
```

### 토큰 사용량 비교

| 시나리오 | 기존 설계 | 개선 설계 | 절감률 |
|----------|-----------|-----------|--------|
| 검색 (20개 결과) | ~8,000 | ~400 | 95% |
| 세션 시작 경고 | ~2,000 | ~150 | 92% |
| 상세 조회 1개 | ~800 | ~500 | 37% |
| **일반적 사용** | **~10,000** | **~1,000** | **90%** |

### 서버 사이드 요약 생성

저장 시 자동으로 짧은 버전 생성:

```typescript
function generateShortVersions(input: ContextSaveInput) {
  return {
    goal_short: truncate(input.goal, 50),
    summary_short: input.summary
      ? truncate(input.summary, 100)
      : null,
    has_warnings: hasFailedApproaches(input) || hasUnresolvedBlockers(input)
  };
}
```

### 필드 길이 제한

| 필드 | 최대 길이 | 용도 |
|------|-----------|------|
| goal | 500자 | 상세 조회 |
| goal_short | 50자 | 검색 결과 힌트 |
| summary | 2000자 | 상세 조회 |
| summary_short | 100자 | 검색 결과 힌트 |

---

## 4. 저장 항목 및 시점

### 저장 항목

| 항목 | 저장 | 시점 | 위치 |
|------|------|------|------|
| 세션 정보 | O | 수동 (context_save) | contexts |
| 대화 요약 | O | 수동 (context_save) | contexts.summary |
| 태그 | O | 수동 (context_save) | contexts.tags |
| 의사결정 | O | 수동 (context_save) | contexts.metadata |
| 시도한 접근법 | O | 수동 (context_save) | contexts.metadata |
| 블로커 | O | 수동 (context_save) | contexts.metadata |
| 실행 명령어 | O | 자동 (필터링) | actions |
| 파일 편집 | O | 자동 | actions |
| 에러 | O | 자동 | actions |

### 액션 자동 저장 정책

```typescript
// config.json
{
  "actionLogging": {
    "enabled": true,
    "commands": {
      "include": [
        "npm install", "npm run", "npm test",
        "yarn", "pnpm",
        "git commit", "git push", "git merge",
        "docker", "docker-compose",
        "python", "pip"
      ],
      "exclude": [
        "ls", "cd", "pwd", "echo",
        "cat", "head", "tail",
        "git status", "git log", "git diff", "git branch"
      ]
    },
    "edits": true,
    "errors": true
  }
}
```

---

## 5. MCP 도구

### 핵심 도구 (4개)

#### context_save

컨텍스트 저장 (모든 메타데이터 포함)

```typescript
interface ContextSaveInput {
  // 필수
  goal: string;

  // 선택
  summary?: string;
  status?: 'planning' | 'coding' | 'testing' | 'reviewing' | 'debugging' | 'completed' | 'paused';
  tags?: string[];
  parentId?: string;                    // 이전 세션 연결

  // 메타데이터 (선택)
  decisions?: Array<{ what: string; why: string }>;
  approaches?: Array<{ description: string; result: string; reason?: string }>;
  blockers?: Array<{ description: string; resolved?: boolean; resolution?: string }>;
  codeChanges?: { modifiedFiles: string[]; summary: string };
}

interface ContextSaveOutput {
  id: string;
  message: string;
  relatedContexts?: Array<{           // 관련 이전 작업 추천
    id: string;
    goal: string;
    summary: string;
    similarity: string;
  }>;
}
```

#### context_search

검색 (힌트 기반, 토큰 효율적)

```typescript
interface ContextSearchInput {
  // 검색 (선택, 하나 이상 필요)
  query?: string;                       // 자연어 검색 (FTS5)
  tags?: string[];                      // 태그 필터
  status?: string;                      // 상태 필터
  agent?: string;                       // 에이전트 필터
  dateRange?: {
    from?: string;                      // ISO 날짜
    to?: string;
  };

  // 옵션
  limit?: number;                       // 기본 5 (최대 20)
  offset?: number;                      // 페이지네이션
  scope?: 'project' | 'global';         // 검색 범위 (v2.1)
}

// 응답: 힌트만 반환 (~20 토큰/항목)
interface ContextSearchOutput {
  hints: Array<{
    id: string;
    goal: string;                       // goal_short (50자)
    date: string;                       // YYYY-MM-DD
    hasWarnings: boolean;               // 실패/블로커 존재 여부
  }>;
  total: number;
  hasMore: boolean;
  suggestion?: string;                  // "ctx_abc에 관련 실패 기록 있음"
}
```

#### context_get

특정 컨텍스트 상세 조회

```typescript
interface ContextGetInput {
  id: string;
  includeActions?: boolean;             // 기본 true
  includeChain?: boolean;               // 연결된 세션 체인 포함
}

interface ContextGetOutput {
  context: {
    id: string;
    parentId?: string;
    goal: string;
    summary: string;
    status: string;
    tags: string[];
    agent: string;
    metadata: ContextMetadata;
    startedAt: string;
    endedAt?: string;
    createdAt: string;
  };
  actions?: Action[];
  chain?: Array<{                       // 연결된 세션들
    id: string;
    goal: string;
    createdAt: string;
  }>;
}
```

#### context_warn

세션 시작 시 경고/추천 조회 (경량, ~100토큰)

```typescript
interface ContextWarnInput {
  currentGoal: string;                  // 현재 작업 목표
  limit?: number;                       // 추천 개수 (기본 3)
}

// 응답: 핵심 경고만 (~100 토큰)
interface ContextWarnOutput {
  warnings: Array<{
    contextId: string;
    message: string;                    // "Axios CORS 문제 발생 (12/20)"
  }>;
  recommendations: Array<{
    id: string;
    goal: string;                       // goal_short (50자)
  }>;
  hasMore: boolean;                     // 더 많은 관련 세션 존재
}
```

**사용 시나리오:**
```
Agent: 세션 시작 → context_warn({ currentGoal: "로그인 기능" })
Server: { warnings: ["JWT 만료 처리 누락 (12/20)"], recommendations: [...] }
Agent: 사용자에게 간단히 알림 후 작업 시작
```

### 유틸리티 도구 (3개)

#### context_stats

세션 통계 조회

```typescript
interface ContextStatsInput {
  range?: 'last_7_days' | 'last_30_days' | 'last_90_days' | 'all';
}

interface ContextStatsOutput {
  totalSessions: number;
  byStatus: Record<string, number>;
  byAgent: Record<string, number>;
  topTags: Array<{ tag: string; count: number }>;
  failedApproaches: number;
  avgActionsPerSession: number;
}
```

#### context_export

컨텍스트 내보내기

```typescript
interface ContextExportInput {
  format: 'markdown' | 'json' | 'html';
  range?: {
    from?: string;
    to?: string;
  };
  contextIds?: string[];                // 특정 컨텍스트만
  output?: string;                      // 파일 경로 (없으면 반환)
}

interface ContextExportOutput {
  content?: string;                     // output 없을 때
  filePath?: string;                    // output 있을 때
  exportedCount: number;
}
```

#### context_recommend

현재 작업과 관련된 이전 세션 추천

```typescript
interface ContextRecommendInput {
  currentGoal: string;
  limit?: number;                       // 기본 5
}

interface ContextRecommendOutput {
  recommendations: Array<{
    id: string;
    goal: string;
    summary: string;
    relevance: 'high' | 'medium' | 'low';
    matchedTags: string[];
    failedApproaches?: string[];        // 실패 경고
  }>;
}
```

---

## 6. 검색 방식

### Agent 기반 검색

벡터 DB나 임베딩 없이, Agent의 언어 이해 능력 활용

```
1. Agent가 자연어 질문 받음
2. MCP 도구로 SQL 검색 (FTS5 + 필터)
3. 후보군 반환 (20개)
4. Agent가 직접 읽고 관련성 판단
5. 최종 결과 선별해서 응답
```

### FTS5 전문검색 활용

```sql
-- "인증" 관련 검색
SELECT c.* FROM contexts c
JOIN contexts_fts fts ON c.rowid = fts.rowid
WHERE contexts_fts MATCH '인증'
ORDER BY rank
LIMIT 20;

-- 복합 검색 (키워드 + 필터)
SELECT c.* FROM contexts c
JOIN contexts_fts fts ON c.rowid = fts.rowid
WHERE contexts_fts MATCH '인증 OR JWT OR 로그인'
  AND c.status = 'completed'
  AND c.created_at > date('now', '-30 days')
ORDER BY rank
LIMIT 20;
```

---

## 7. 권장 사용 패턴

### 일반적인 세션 흐름

```
┌─────────────────────────────────────────────────────────────┐
│ 1. 세션 시작                                                │
│    context_warn({ currentGoal: "..." })                    │
│    → ~100 토큰 (경고/추천만)                               │
├─────────────────────────────────────────────────────────────┤
│ 2. 필요시 검색                                              │
│    context_search({ query: "..." })                        │
│    → ~200 토큰 (힌트만)                                    │
├─────────────────────────────────────────────────────────────┤
│ 3. 상세 필요시                                              │
│    context_get({ id: "ctx_abc" })                          │
│    → ~500 토큰 (전체 정보)                                 │
├─────────────────────────────────────────────────────────────┤
│ 4. 세션 종료                                                │
│    context_save({ goal: "...", summary: "..." })           │
│    → 저장만 (응답 최소)                                    │
└─────────────────────────────────────────────────────────────┘

총 예상: 300-800 토큰 (기존 대비 90% 절감)
```

### 도구별 토큰 예산

| 도구 | 예상 토큰 | 호출 빈도 | 용도 |
|------|-----------|-----------|------|
| context_warn | ~100 | 세션당 1회 | 시작 시 경고 확인 |
| context_search | ~200 | 필요시 | 힌트 목록 조회 |
| context_get | ~500 | 필요시 | 상세 정보 조회 |
| context_save | ~50 | 세션당 1-2회 | 저장 (응답 최소) |

### Anti-Pattern (피해야 할 것)

```typescript
// ❌ 나쁜 예: 한 번에 모든 정보 요청
context_search({ query: "인증", includeActions: true, limit: 20 })

// ✅ 좋은 예: 힌트 먼저, 필요시 상세
const hints = context_search({ query: "인증" })  // 힌트만
if (hints.total > 0) {
  context_get({ id: hints.hints[0].id })         // 필요한 것만
}
```

---

## 8. 추가 기능

### 8.1 세션 연결 (Session Linking)

```typescript
context_save({
  goal: "로그인 버그 수정",
  parentId: "previous-session-id"       // 이전 세션 연결
})
```

체인 조회:
```
세션 A: 로그인 기능 구현
    ↓
세션 B: 로그인 버그 수정
    ↓
세션 C: 로그인 테스트 추가
```

### 8.2 관련 세션 자동 추천

세션 시작 시 관련 이전 작업 자동 제안:

```
Agent: "관련 이전 작업이 있습니다:
        - JWT 로그인 구현 (12/25)
        - 토큰 만료 버그 수정 (12/20)
        참고할까요?"
```

### 8.3 실패 패턴 경고

비슷한 작업 시작 시 이전 실패 기록 경고:

```
Agent: "⚠️ 이전에 비슷한 작업에서 실패한 기록이 있습니다:
        - Axios 대신 fetch 사용 시 CORS 문제 발생
        참고하세요."
```

### 8.4 프로젝트 간 검색 (v2.1)

```
~/.context-sync/
└── global.db         # 전체 프로젝트 인덱스

context_search({
  query: "OAuth 구현",
  scope: "global"
})
```

---

## 9. 마이그레이션

### 기존 데이터 이전

```typescript
async function migrate() {
  // 1. 기존 current.json 로드
  const current = await loadJSON('.context-sync/current.json');

  // 2. contexts 테이블에 삽입
  await db.run(`
    INSERT INTO contexts (id, goal, summary, status, tags, agent, metadata, started_at, created_at)
    VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
  `, [
    current.id,
    current.currentWork.goal,
    '', // summary 없음
    current.currentWork.status,
    JSON.stringify([]),
    current.agentChain[0]?.to || 'unknown',
    JSON.stringify({
      decisions: current.conversationSummary.keyDecisions,
      approaches: current.conversationSummary.triedApproaches,
      blockers: current.conversationSummary.blockers,
      codeChanges: current.codeChanges
    }),
    current.currentWork.startedAt,
    current.createdAt
  ]);

  // 3. 기존 snapshots 이전
  const snapshots = await loadSnapshots('.context-sync/snapshots/');
  for (const snapshot of snapshots) {
    await migrateSnapshot(snapshot);
  }
}
```

---

## 10. 구현 단계

### Phase 1: 코어 (v2.0) ✅ 완료

- [x] ~~better-sqlite3~~ sql.js 설정 (WebAssembly 기반, 크로스 플랫폼)
- [x] 스키마 생성 및 마이그레이션 (goal_short, summary_short, has_warnings 포함)
- [x] ContextStore 리팩토링 (JSON + DB 하이브리드)
- [x] 서버 사이드 요약 생성 (truncate 로직)
- [x] 핵심 도구 구현:
  - [x] context_save (짧은 버전 자동 생성)
  - [x] context_search_v2 (힌트 기반 응답, ~200 토큰)
  - [x] context_get (상세 조회, ~500 토큰)
  - [x] context_warn (경고/추천, ~100 토큰)
- [x] FTS5 전문검색 구현
- [x] 액션 자동 로깅
- [x] 세션 연결 (parentId)
- [x] current.json 동기화

### Phase 2: 확장 (v2.1)

- [ ] context_stats 구현
- [ ] context_export 구현
- [ ] context_recommend 구현
- [ ] 실패 패턴 경고
- [ ] 프로젝트 간 검색 (global.db)

### Phase 3: 최적화 (v2.2)

- [ ] 성능 최적화 (인덱스 튜닝)
- [ ] 대용량 데이터 처리
- [ ] 오래된 데이터 아카이빙

---

## 11. 설정

### config.json 구조

```json
{
  "storage": {
    "location": ".context-sync",
    "dbFile": "history.db",
    "keepJsonSync": true
  },
  "actionLogging": {
    "enabled": true,
    "commands": {
      "include": ["npm", "git commit", "docker"],
      "exclude": ["ls", "cd", "git status"]
    },
    "edits": true,
    "errors": true
  },
  "search": {
    "defaultLimit": 20,
    "ftsLanguage": "unicode61"
  },
  "recommendations": {
    "enabled": true,
    "showOnSessionStart": true,
    "warnOnFailedPatterns": true
  }
}
```

---

## 12. 파일 구조

```
packages/context-sync-mcp/
├── src/
│   ├── index.ts                 # MCP 서버 엔트리
│   ├── db/
│   │   ├── index.ts             # DB 초기화
│   │   ├── schema.ts            # 스키마 정의
│   │   └── migrations.ts        # 마이그레이션
│   ├── store/
│   │   ├── context-store.ts     # 리팩토링 (DB + JSON)
│   │   └── action-store.ts      # 액션 로깅
│   ├── search/
│   │   ├── context-search.ts    # FTS5 검색
│   │   └── recommendations.ts   # 추천 로직
│   ├── tools/
│   │   ├── context-save.ts
│   │   ├── context-search.ts
│   │   ├── context-get.ts
│   │   ├── context-warn.ts         # 경고/추천 (경량)
│   │   ├── context-stats.ts
│   │   ├── context-export.ts
│   │   └── context-recommend.ts
│   ├── sync/
│   │   └── json-sync.ts         # current.json 동기화
│   └── types/
│       └── index.ts             # 타입 정의
├── docs/
│   └── v2.0-plan.md             # 이 문서
└── package.json
```

---

## 13. 의존성

```json
{
  "dependencies": {
    "@modelcontextprotocol/sdk": "^1.0.0",
    "chokidar": "^3.5.3",
    "sql.js": "^1.13.0",
    "zod": "^3.22.4"
  },
  "devDependencies": {
    "@types/node": "^20.10.0",
    "@types/sql.js": "^1.4.9",
    "typescript": "^5.3.0"
  }
}
```

> **Note:** better-sqlite3에서 sql.js로 변경됨. 네이티브 컴파일 없이 모든 플랫폼에서 동작.

---

## 변경 이력

| 버전 | 날짜 | 변경 내용 |
|------|------|----------|
| v2.0-draft | 2025-12-27 | 초안 작성 |
| v2.0-draft2 | 2025-12-27 | 토큰 효율성 전략 추가: 2단계 응답 패턴, context_warn 도구, goal_short/summary_short 필드, 권장 사용 패턴 |
| v2.0-rc1 | 2025-12-27 | Phase 1 구현 완료: sql.js 기반 SQLite, 토큰 효율적 도구들 (context_search_v2, context_get, context_warn) |
| v2.0 | 2025-12-27 | better-sqlite3 → sql.js 전환 (WebAssembly 기반, 크로스 플랫폼 호환성) |
